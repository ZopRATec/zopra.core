<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="zopra">

<body>
    <tal:comment tal:replace="nothing">

    </tal:comment>

      <metal:css_slot fill-slot="css_slot">
            <link rel="stylesheet" type="text/css" media="all"  tal:attributes="href string:${portal_url}/zopra.css" />
            <link rel="stylesheet" type="text/css" media="all"  tal:attributes="href string:${portal_url}/zopra_edit.css" />
            <link rel="stylesheet" type="text/css" media="print"  tal:attributes="href string:${portal_url}/sins_print.css" />
        
            <link rel="stylesheet" type="text/css" tal:attributes="href string:${portal_url}/zoprajs/fancybox/jquery.fancybox-1.3.4.css" media="screen" />
            <link rel="stylesheet" type="text/css" tal:attributes="href string:${portal_url}/zoprajs/fancybox-textarea/jquery.fancybox.textarea.css" media="screen" />
            <link rel="stylesheet" type="text/css" tal:attributes="href string:${portal_url}/zoprajs/multi-select/multi-select.css" media="screen" />
            <link rel="stylesheet" type="text/css" tal:attributes="href string:${portal_url}/smoothness/jquery-ui-1.8.16.custom.css" media="screen" />
      </metal:css_slot>

      <metal:javascriptslot fill-slot="javascript_head_slot">
            <script type="text/javascript" tal:attributes="src string:${portal_url}/jquery-ui-1.8.16.custom.min.js"></script>
            <script type="text/javascript" tal:attributes="src string:${portal_url}/zoprajs/fancybox/jquery.fancybox-1.3.4.pack.js"></script>
            <script type="text/javascript" tal:attributes="src string:${portal_url}/zoprajs/multi-select/jquery.multi-select.1.6.js"></script>
            <script type="text/javascript" tal:attributes="src string:${portal_url}/zoprajs/fancybox-textarea/jquery.fancybox.textarea.js" charset="utf-8"></script>
            <script language="javascript">
            <!--
                  $(document).ready(function() {
                      $("textarea").textareaPopup();
                      $("select.multi").multiSelect({selectedHeader:"&nbsp;Gewählte Items", selectableHeader: "&nbsp;Auswählbare Items", });
                  });
            -->
            </script>
      </metal:javascriptslot>

      <metal:main fill-slot="main" tal:define="table request/table;">
            <tal:block tal:condition="isAnon">
                  <div tal:define="dummy python: request.RESPONSE.redirect('/login_form')" />
            </tal:block>
            <form name="edit_form"
                  action="."
                  method="post"
                  enctype="multipart/form-data"
                  tal:define="errors options/state/getErrors;
                           tobj python: here.tableHandler[table];
                           coltypes python:tobj.getColumnDefs();
                           fieldsets python:here.getLayoutInfo(table, 'create');
                           helpTexts python: here.getHelpTexts(table);
                           origtable request/origtable|nothing;
                           origid request/origid|nothing;
                           origattribute request/origattribute|nothing;
                           entry python: request.get('autoid') and tobj.getEntry(request.get('autoid')) or here.getDefaultCreateValues(table);
                           required python: here.getGenericConfig(table).get('required',[]);"
                  tal:attributes="action string:${here/getId}/${template/getId}" >


              <h1 i18n:translate="" tal:content="python: 'Erstellung ' + tobj.getLabel()"></h1>
              <metal:block metal:use-macro="here/zopra_button_link_bar/macros/buttons_add" />
				  
              <tal:block tal:define="show_additional python: not here.doesTranslations(table) or entry.get('language') == 'de'"
                         tal:repeat="fieldset fieldsets">
                <fieldset id="addFieldset"
				          tal:define="add_macro python: 'additional_%s_%s' % (table, fieldset.get('label'));
                                      add_path python: 'zopra_table_create_additional_%s' % here.meta_type;
                            add_check python: 'zopra_table_create_has_additional_%s' % here.meta_type;
                            add_checked python: exists(add_check) and getattr(here, add_check)(table, entry, request);
                            add_hascontent python: not exists(add_check) or add_checked"
                          tal:condition="python: fieldset.get('fields') or (exists('here/?add_path/macros/?add_macro') and add_hascontent)">

                        <legend i18n:translate="" tal:attributes="id python:fieldset.get('id') or fieldset.get('label')" tal:content="fieldset/label">Datenfelder</legend>
                        <tal:block tal:define="sortables python: fieldset.get('sortables', []);
                                               fieldlist python: 'repeatfields' in fieldset.keys() and context.listdiff(fieldset['fields'], fieldset['repeatfields']) or fieldset['fields'];"
                                   tal:repeat="attr_name fieldlist">
                          <tal:block tal:define="br br|nothing;
						                         global br python: br or attr_name == '<br>'"
						             tal:condition="python: attr_name != '<br>'">
						   
                            <tal:check tal:define="dummy python: not coltypes.get(attr_name) and here.migrate_raiser('Field not found: ' + attr_name)"></tal:check>

                            <div class="field"
                                 tal:define="error python: errors.get(attr_name);
                                         attr_value python:request.get(attr_name, '') or entry.get(attr_name, '');
                                         field python:coltypes[attr_name];
                                         attr_type python:field['TYPE'];
                                         attr_sort python:attr_name in sortables;
                                         attr_notes python:{}"
                                 tal:attributes="class python: 'field' + (error and ' error' or '') + (br and ' floatclearer' or '')"
                                 tal:condition="python: not field.get('INVIS')">

                              <label tal:attributes="for attr_name" tal:content="python: field['LABEL']" i18n:translate="">Attribute Name</label>

                              <span class="fieldRequired"
                                    title="Required"
                                    i18n:attributes="title"
                                    i18n:translate="label_required"
                                    tal:define="isreq python: attr_name in required;"
                                    tal:condition="isreq">
                                (Required)
                              </span>

                              <div class="formHelp"
                                   tal:content="helpTexts/?attr_name |nothing">
                                Hinweistext
                              </div>

                              <div tal:condition="error" tal:content="error" i18n:translate="">Validation error output</div>

                              <metal:block metal:use-macro="here/zopra_widget_edit_display/macros/widget_selector" />

                            </div>
							<tal:check tal:define="global br python:False"></tal:check>
						  </tal:block>
                        </tal:block>
                        <tal:repeatfields condition="python: 'repeatfields' in fieldset.keys()">
                              <div style="clear:both;"></div>
                              Wählen Sie aus wie oft die folgenden Felder benötigt werden
                              <select name="repeats_select" id="repeats_select" tal:define="length python: range(1, 21);">
                                    <tal:block tal:repeat="i length">
                                    <option tal:content="i" tal:attributes="value python: str(i);
                                                                            selected python: int(request.get('repeats','1'))==i and 'selected' or ''"></option>
                                    </tal:block>
                              </select>
                              <script type="text/javascript">
                                    $(document).ready(function(){
                                          $('#repeats_select').change(function(){
                                                var currentCount = parseInt($("#repeats").val());
                                                var val    = parseInt($(this).val());
                                                var master = $($('.repeatFields')[0]);
                                                if(val > currentCount){
                                                      for(i = currentCount + 1; i <= val; i++){
                                                            var clone  = master.clone();
                                                            fields = clone.find('input, textarea');
                                                            for(j in fields){
                                                                  if(!isNaN(j)){
                                                                        field = $(fields[j]);
                                                                        field.attr('name', field.attr('name') + '_' + i);
                                                                        field.attr('id',   field.attr('id')   + '_' + i);
                                                                  }
                                                            }
                                                            clone.data('repeat-field-number', i);
                                                            clone.attr('id', 'repeatItem_' + i);
                                                            clone.css("display", "none");
                                                            $('#addFieldset').append(clone);
                                                            clone.slideDown("fast");
                                                      }
                                                }else if(val < currentCount){
                                                      console.log(val, currentCount);
                                                      for(i = currentCount; i > val; i--){
                                                            var field = $('#repeatItem_' + i);
                                                            field.slideUp("fast", function(){$(this).remove()});
                                                      }
                                                }

                                                $("#repeats").val(val);
                                          });
                                    })
                              </script>
                              <style type="text/css">
                                    .border{
                                          border-bottom:1px solid #999;
                                          padding:0 0 10px 0;
                                          margin:0 0 10px 0;
                                    }
                              </style>
                              <input type="hidden" name="repeats" id="repeats" tal:attributes="value python: int(request.get('repeats','1'))">
                              <div style="clear:both;"></div>
                              <tal:repeat define="repeats request/repeats|nothing;
                                                  repeats python: repeats and range(1,int(repeats)+1) or [1];
                                                  sortables python: fieldset.get('sortables', [])"
                                          repeat="field_num repeats">
                                    <div tal:attributes="class python: repeat['field_num'].index < len(repeats)-1 and 'border repeatFields' or 'repeatFields';
                                                         data-repeat-field-number python: field_num and field_num or 1;
                                                         id python: 'repeatItem_' + str(field_num);">
                                          <tal:fields repeat="attr_name fieldset/repeatfields">
                                                <div tal:define="error python: errors.get(attr_name);
                                                               attr_value python:request.get(attr_name, '') or entry.get(attr_name, '');
                                                               field python:coltypes[attr_name];
                                                               attr_type python:field['TYPE'];
                                                               attr_sort python:attr_name in sortables;
                                                               attr_notes python:{}"
                                                     tal:attributes="class python: error and 'field error' or 'field'"
                                                     tal:condition="python: not field.get('INVIS')">

                                                      <label tal:attributes="for attr_name" tal:content="python: field['LABEL']" i18n:translate="">Attribute Name</label>

                                                      <span class="fieldRequired"
                                                            title="Required"
                                                            i18n:attributes="title"
                                                            i18n:translate="label_required"
                                                            tal:define="isreq python: attr_name in required;"
                                                            tal:condition="isreq">
                                                            (Required)
                                                      </span>

                                                      <div class="formHelp"
                                                           tal:content="helpTexts/?attr_name |nothing">
                                                            Hinweistext
                                                      </div>

                                                      <div tal:condition="error" tal:content="error" i18n:translate="">Validation error output</div>

                                                      <tal:block define="attr_name python: field_num-1 and attr_name+'_'+str(field_num) or attr_name">
                                                            <metal:block metal:use-macro="here/zopra_widget_edit_display/macros/widget_selector" />
                                                      </tal:block>

                                                </div>
                                                <div style="clear:both;"></div>
                                          </tal:fields>
                                    </div>
                              </tal:repeat>
                        </tal:repeatfields>
                        <tal:additional tal:condition="exists: here/?add_path/macros/?add_macro">
                              <metal:use metal:use-macro="here/?add_path/macros/?add_macro">
                                    Additional Fields
                              </metal:use>
                        </tal:additional>

                  </fieldset>
				</tal:block>

                <metal:block metal:use-macro="here/zopra_button_link_bar/macros/buttons_add" />

                  <tal:comment tal:replace="nothing">
                        Next section is used for creating dependent entries that will be inserted
                        into a multilist column named origattribute of the entry with origid from table origtable
                        This will be replaced by javascript, that fills the selected-list of the multilist after creation.
                        On Unselect, these entries have to be deleted then via javascript too.
                  </tal:comment>
                  <input tal:condition="origtable" type="hidden" name="origtable"
                         tal:attributes="value origtable" />
                  <input tal:condition="origid" type="hidden" name="origid"
                         tal:attributes="value origid" />
                  <input tal:condition="origattribute" type="hidden" name="origattribute"
                         tal:attributes="value origattribute" />

                  <input type="hidden" name="form.submitted" value="1" />
                  <input type="hidden" name="table" tal:attributes="value table" />

            </form>
      </metal:main>

      <metal:column_two_slot fill-slot="column_two_slot">
            <metal:block metal:use-macro="here/zopra_context_menu/macros/context_menu" />
      </metal:column_two_slot>

      <metal:bottom fill-slot="bottom">
            <metal:block metal:use-macro="here/zopra_bottom/macros/bottom" />
      </metal:bottom>

</body>
</html>
